<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grocery Price Tracker</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --line:rgba(255,255,255,.12);
      --accent:#7dd3fc;
      --accent2:#c4b5fd;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(1100px 700px at 15% 10%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(900px 650px at 85% 15%, rgba(196,181,253,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px;
      box-sizing:border-box;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{ font-size:20px; font-weight:800; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      background: linear-gradient(135deg, rgba(125,211,252,0.28), rgba(196,181,253,0.22));
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    select{
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      outline: none;
      font-weight: 600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.28);
      overflow:hidden;
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.35px;
      text-transform:uppercase;
    }

    .items{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 700px){
      .items{ grid-template-columns: 1fr; }
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      background: rgba(0,0,0,.10);
      transition: transform .08s ease, border-color .08s ease;
    }
    .item:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.35); }
    .item.active{ border-color: rgba(196,181,253,.55); }
    .item .name{ font-weight:800; font-size:14px; display:flex; gap:8px; align-items:center; }
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.85);
      background:rgba(0,0,0,.18);
      line-height:1.6;
      white-space:nowrap;
    }
    .badge.stale{
      border-color: rgba(251,191,36,.55);
      color: rgba(251,191,36,.98);
    }
    .item .meta{ margin-top:6px; color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .source-link{
      color: var(--accent);
      font-weight: 700;
      text-decoration: none;
    }
    .source-link:hover{ text-decoration: underline; }

    .kpis{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .val{ font-size:18px; font-weight:900; margin-top:6px; }

    /* FIX: bounded chart containers prevent runaway vertical growth */
    .chartBox{ height: 280px; position: relative; }
    .chartBox.tall{ height: 330px; }
    .chartBox canvas{
      width: 100% !important;
      height: 100% !important;
      max-height: 100% !important;
      display:block;
    }

    .note{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }
    .good{ color: var(--good); font-weight:900; }
    .bad{ color: var(--bad); font-weight:900; }
    .warn{ color: var(--warn); font-weight:900; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Grocery Price Tracker (USD + sats)</div>
        <div class="sub" id="status">Loaded. Run <b>setupOnce()</b> once in Apps Script, then use the buttons here.</div>
      </div>
      <div class="row">
        <button class="btn" id="btnFetch">Fetch Latest</button>
        <button class="btn" id="btnRecord">Record Snapshot</button>
        <button class="btn" id="btnBasket">Refresh Basket</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Items (click one)</h3>
        <div class="items" id="items"></div>
        <div class="note">
          “Fetch Latest” updates the UI (cached 10 min). “Record Snapshot” writes permanent history.
          If the provider is down, the app may show <span class="warn">stale</span> last-known prices.
        </div>
      </div>

      <div class="card">
        <h3>Basket inflation</h3>
        <div class="kpis">
          <div class="kpi">
            <div class="label">BTC/USD</div>
            <div class="val" id="btcUsd">—</div>
          </div>
          <div class="kpi">
            <div class="label">Inflation vs baseline</div>
            <div class="val" id="infl">—</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="chartBox tall">
          <canvas id="basketChart"></canvas>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="row" style="justify-content:space-between;">
          <h3 style="margin:0;" id="itemTitle">Item history</h3>
        </div>

        <div style="height:12px"></div>
        <div class="chartBox">
          <canvas id="itemChart"></canvas>
        </div>

        <div class="note" id="itemNote"></div>
      </div>
    </div>
  </div>

<script>
  let cfg = null;
  let latest = null;
  let activeItemId = null;

  let itemChart = null;
  let basketChart = null;

  const $ = (id) => document.getElementById(id);

  function setStatus(msg){ $("status").innerHTML = msg; }

  function fmtUsd(n){
    if (!isFinite(n)) return "—";
    return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
  }
  function fmtSats(n){
    if (!isFinite(n)) return "—";
    return Math.round(n).toLocaleString() + " sats";
  }

  function destroyChartSafe(ch){
    if (ch && typeof ch.destroy === "function") ch.destroy();
    return null;
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function getSourceUrl(row, item){
    if (row && row.source_url) return row.source_url;
    if (item && item.query) {
      return "https://www.google.com/search?tbm=shop&q=" + encodeURIComponent(item.query);
    }
    return "";
  }

  function renderItems(){
    const root = $("items");
    root.innerHTML = "";

    cfg.items.forEach(it => {
      const row = latest?.items?.find(x => x.id === it.id);
      const usd = row?.usd;
      const sats = row?.sats;
      const stale = Boolean(row?.is_stale);
      const source = row?.price_source || "";
      const description = row?.item_description || it.name;
      const sourceUrl = getSourceUrl(row, it);

      const div = document.createElement("div");
      div.className = "item" + (it.id === activeItemId ? " active" : "");
      div.onclick = () => selectItem(it.id);

      const badge = stale ? `<span class="badge stale">STALE</span>` :
                   source ? `<span class="badge">${escapeHtml(source)}</span>` : "";

      div.innerHTML = `
        <div class="name">${escapeHtml(description)} ${badge}</div>
        <div class="meta">
          <span>${usd != null ? fmtUsd(usd) : "—"}</span>
          <span>${sats != null ? fmtSats(sats) : "—"}</span>
          ${sourceUrl ? `<a class="source-link" href="${escapeHtml(sourceUrl)}" target="_blank" rel="noopener noreferrer">Source</a>` : ""}
        </div>
      `;
      root.appendChild(div);
    });
  }

  async function selectItem(itemId){
    activeItemId = itemId;
    renderItems();
    await renderItemHistory();
  }

  async function loadConfig(){
    cfg = await new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getConfig();
    });
  }

  async function fetchLatest(){
    setStatus("Fetching latest snapshot (cached 10 minutes)...");
    $("btnFetch").disabled = true;

    try{
      latest = await new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).fetchLatestSnapshot();
      });

      $("btcUsd").textContent = fmtUsd(latest.btcUsd);

      if (!activeItemId && cfg.items.length) activeItemId = cfg.items[0].id;
      renderItems();

      await renderItemHistory();
      await renderBasket();

      const anyStale = (latest.items || []).some(x => x.is_stale);
      setStatus(
        "Latest fetched: <b>" + new Date(latest.ts).toLocaleString() + "</b>" +
        (anyStale ? " — <span class='warn'>some prices are stale (fallback)</span>" : "")
      );

    } catch (err) {
      setStatus("<b style='color:#fb7185'>Fetch failed:</b> " + escapeHtml(String(err)));
    } finally {
      $("btnFetch").disabled = false;
    }
  }

  async function recordSnapshot(){
    setStatus("Recording snapshot to permanent history...");
    $("btnRecord").disabled = true;

    try{
      const res = await new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).recordSnapshot();
      });

      setStatus("Recorded <b>" + res.rowsAppended + "</b> rows at <b>" + new Date(res.recordedAt).toLocaleString() + "</b>");
      await renderBasket();
      await renderItemHistory();

    } catch (err) {
      setStatus("<b style='color:#fb7185'>Record failed:</b> " + escapeHtml(String(err)));
    } finally {
      $("btnRecord").disabled = false;
    }
  }

  async function renderItemHistory(){
    if (!activeItemId) return;

    const item = cfg.items.find(x => x.id === activeItemId);
    const latestRow = latest?.items?.find(x => x.id === activeItemId);
    const description = latestRow?.item_description || item?.name || "Item history";

    const hist = await new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getItemHistory(description);
    });

    const staleCount = hist.filter(x => x.is_stale).length;

    $("itemTitle").textContent = description;
    $("itemNote").innerHTML =
      (description ? ("Description: <b>" + escapeHtml(description) + "</b>") : "") +
      (staleCount ? (" — <span class='warn'>" + staleCount + " stale points</span>") : "");

    const labels = hist.map(p => new Date(p.ts).toLocaleString());
    const usdSeries = hist.map(p => Number(p.usd) * 1000);
    const satsSeries = hist.map(p => Number(p.sats));

    itemChart = destroyChartSafe(itemChart);

    const ctx = $("itemChart").getContext("2d");
    itemChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "USD (x1000)",
          data: usdSeries,
          borderColor: "#7dd3fc",
          backgroundColor: "rgba(125,211,252,0.15)",
          pointBackgroundColor: "#7dd3fc",
          pointBorderColor: "#7dd3fc",
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        }, {
          label: "sats",
          data: satsSeries,
          borderColor: "#fbbf24",
          backgroundColor: "rgba(251,191,36,0.15)",
          pointBackgroundColor: "#fbbf24",
          pointBorderColor: "#fbbf24",
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: true } },
        scales: {
          x: { ticks: { maxTicksLimit: 6 } },
          y: {
            title: {
              display: true,
              text: ["USD (x1000)", "sats"]
            }
          }
        }
      }
    });
  }

  async function renderBasket(){
    const hist = await new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBasketHistory();
    });

    const infl = await new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getBasketInflation();
    });

    const pct = Number(infl.inflationPct || 0);
    const cls = pct >= 0 ? "bad" : "good";
    $("infl").innerHTML = `<span class="${cls}">${pct.toFixed(2)}%</span>`;

    const labels = hist.map(p => new Date(p.ts).toLocaleDateString());
    const usd = hist.map(p => Number(p.basketIndexUsd) * 1000);
    const sats = hist.map(p => Number(p.basketIndexSats));

    basketChart = destroyChartSafe(basketChart);

    const ctx = $("basketChart").getContext("2d");
    basketChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Basket Index (USD x1000)", data: usd, borderWidth: 2, tension: 0.25, pointRadius: 2 },
          { label: "Basket Index (sats)", data: sats, borderWidth: 2, tension: 0.25, pointRadius: 2 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: true } },
        scales: { x: { ticks: { maxTicksLimit: 8 } } }
      }
    });
  }

  $("btnFetch").addEventListener("click", fetchLatest);
  $("btnRecord").addEventListener("click", recordSnapshot);
  $("btnBasket").addEventListener("click", renderBasket);

  (async () => {
    try {
      await loadConfig();
      renderItems();
      setStatus('Loaded. Next: run <b>setupOnce()</b> once (in Apps Script), then click <b>Fetch Latest</b>.');
    } catch (err) {
      setStatus("<b style='color:#fb7185'>Init failed:</b> " + escapeHtml(String(err)));
    }
  })();
</script>
</body>
</html>
